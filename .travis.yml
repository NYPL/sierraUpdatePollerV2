language: ruby
rvm:
- 2.7.0
before_install:
- wget https://releases.hashicorp.com/terraform/"$TF_VERSION"/terraform_"$TF_VERSION"_linux_amd64.zip
- unzip terraform_"$TF_VERSION"_linux_amd64.zip
- sudo mv terraform /usr/local/bin/
- rm terraform_"$TF_VERSION"_linux_amd64.zip
- gem update --system
- gem install bundler
- gem install aws-sdk-lambda
- gem install aws-sdk-cloudwatchevents
install:
- rake run_bundler
jobs:
  include:
  - stage: test
    script:
    - rake test
  - stage: deploy qa
    if: type IN (push) and branch = qa
    env:
    - AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID_QA
    - AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY_QA
    script:
    - rm -rf vendor
    - bundle install --without test
    - terraform -chdir=provisioning/qa init -input=false
    - echo "Deploying to qa"
    - terraform -chdir=provisioning/qa apply -auto-approve -input=false
  - stage: deploy production
    if: type IN (push) and branch = main
    env:
    - AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID_PRODUCTION
    - AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY_PRODUCTION
    script:
    - rm -rf vendor
    - bundle install --without test
    - terraform -chdir=provisioning/production init -input=false
    - echo "Deploying to production"
    - terraform -chdir=provisioning/production apply -auto-approve -input=false
env:
  global:
  - TF_VERSION=1.0.11
  - secure: JG/MvYxf/9U8qKeB0fUCtwwX/ld5Ab6TFuNlJLLJaWoYfYuzK867rUx50RtGGtWh6jR2LAGr0eQigDFivX4U9T7XEBLU293XKZHM8q/WgRmmY4C0/PZYZ5ip19kXJDDxemj+Ubj+MfV2qYC/1/qu1AGNIbgL0TbMg7yHSEWqOKfEGDdCRagNFBbEFZRqk7BPEFKpaZntWhIRWIcGBt0B+LYLMU2NvjnA/TuZpNbK49ypt46/rSJKsUpcBdpWJYCLzVmuFPZaG+Ao5++iqGYRue/8Lot0Qv4RSQA0iVkkYT0kNvZjEQlK+iiO1O+ymt1px1Y/l08qnxJ0Two/+0YzG4P5bjnz6SFHVz3eiL9Pwy2cjQY/OKGAipnVD3W+qiNpMM4H4/5Zmq17x+uMHywShh0IccaFmE5acLJbTv6QgogjiKok0HulZXYStjQcFGdGvSTXWlbIObBJXC68rt+nhCQ1lfguBlqCcwC0S0kqh7qPJn+EH+BW+jKJAXDjrmylRvCMTKcoW4EdtnOpN9d6tEPEMuMqvk7so9cYrvj6/jp6B4j2QyExPjax9BqjWdsnr74M9hfNlVO5Wo/u6UD0/Wwg4JR2BQ/22bP0d1Px2x5QKZ/wi+tUuYdD4FEkBWmjr9Vr96yigx8V8sW+iuD6UX5YFM9YVqc1UX+Yd70nV9U=
