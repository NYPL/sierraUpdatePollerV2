language: ruby
rvm:
- 2.7.0
before_install:
- wget https://releases.hashicorp.com/terraform/"$TF_VERSION"/terraform_"$TF_VERSION"_linux_amd64.zip
- unzip terraform_"$TF_VERSION"_linux_amd64.zip
- sudo mv terraform /usr/local/bin/
- rm terraform_"$TF_VERSION"_linux_amd64.zip
- gem update --system
- gem install bundler
- gem install aws-sdk-lambda
- gem install aws-sdk-cloudwatchevents
install:
- rake run_bundler
jobs:
  include:
  - stage: test
    script:
    - rake test
  - stage: deploy qa
    if: type IN (push) and branch = qa
    env:
    - AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID_QA
    - AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY_QA
    script:
    - rm -rf vendor
    - bundle install --without test
    - terraform -chdir=provisioning/qa init -input=false
    - echo "Deploying to qa"
    - terraform -chdir=provisioning/qa apply -auto-approve -input=false
  - stage: deploy production
    if: type IN (push) and branch = main
    env:
    - AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID_PRODUCTION
    - AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY_PRODUCTION
    script:
    - rm -rf vendor
    - bundle install --without test
    - terraform -chdir=provisioning/production init -input=false
    - echo "Deploying to production"
    - terraform -chdir=provisioning/production apply -auto-approve -input=false
env:
  global:
  - secure: ej1NpVaMqvi3ZUHegVljz0xN2U/bJyyXArMYty6X32X6gCzIcUILofF1yNW0ypY14Ju1HEP9AE/4OV5+EWGgTv+7V9G1Z3mEXE3O17Jwh21qBYLamtO19eQK6tu4M5zwZldkfzNiLXHXyyTfyZRuf0afZxOW67o8eN94qfxMe0TnKT+JiFZNZVxRAipNew9fZrMZtuJxzqnMF7CJXjHRD89ZxcdfBPHZ0DIu8JygwrmXR5ECyvnDpwopl4WFTvmMsGkoMn5uoAVeIUZCshPZvAtQ3gXCV4N1xVdEBlfc4XTtUfN7gxb3PX9jTRdcieMgPrLFr8bozLgqFSz2EHONg2tkgsK/imt1IYSr9fEm/6n7L/DznAt2e0QH1OG9wPC1qFp5rUeIUYFA9xh1ocYPh11B96KrXAtsCgF5lkjaGxdqgh/ADAS9JE4qQftF6X4er4COvY0yJ36LNd/4gxOW4alyT4z8A2s39OAwvwAGNH2gAdN3Ay6ECXOZqsy+ZwdQU+n8g9UGUW06pQU6W5HLQdq/aUyMz1S4D5o4z0N/ZxRfAOiBd8g8Oh8HXfw2oLtIo4GlOXrowc9hQ2/dYk01ab62V+RgZuZLxquG/SJWmyiV295qtaCqJZK79Q1DQJ7Wtmzqtz2dxLfGOG8v9U8f2gu4hQskhLaIvVM8yl6tyVU=
  - secure: AeCbmxvFbOUOFzDwG5r/7A66yTOMj5Wn5CuiDjh1OsIP2JYQF/4J7wQjcA/OV2xpY0fpXd/6PogcCTOzFI+8xMznF4THwCjXH3wMpbr8AHzCnTVIwxCeI/a2k9jRgO6+RwSbejiR1Lo+vJX1AJhfHmoCFMdwbcwRBhgGezVd0xNCVcdOGCFL4vr4XZ2z5hGUODAtM9rrkI5GZN5fy/rpvy+3mXP3Idjz14OerquQcdir4TBkIiNribhT36ohSMOVWZ64woOylvF2YrJAISebu/4yy2cUXO+/JCJ+HukZJPuk5umDcyjkZwwy30llWbttuxnoD9ubgrkqe5vquCZlST8ouaAk5Adx+jJXrP2dGWvoyIFcShR0yfIqKacHJ1365x6PDQ5oHNUrQo99jCIxGehFdWrnGJjhBRXMzPsWgLxkelFr7jJ4UwbNwWmMsirIAQ9I1E8uaBTqVl9bkIH+W0p5sFN1Z6apVKvBZj/EwBYYUZmcyMv6ohfBhVxRpFZxeixZrfbUHCwQXPXkem898XPYLxOZis4zN9safvdPmhaj/nId/djJGBU+vAG+DL4XdVTMPw1zmhYZFi5MTjw+SGGVJ2q5pXMax4wiNjafNjhoUoCFvPcI0xzu1AFlAFptYz42qGYsl0DGYLu/mZJLKrLvQsbfTuxcapCmNkvhiqI=
  - secure: AeUm+x8wVtEEnlQgEZjxYHcwv7p/p9nxrVuvRNbQ3OaXpHIlTnJqSOecs0FqcMtJx2LMi2X4LD6K3/xdgC9FELDF3fqMeFPlEDWg+02mftUiswxS2kBfrH+fskYT7yoMRez1+g9z3qRSQzlb5d7yYqKsZGBkn+l0R33Pke4NFcUi3pKI9ws7hORLu8uQCWj/hPjKPR7h12dy5mXsFSyEJWKG/VPjDBi/apf1TYKlNUj3IhSQnzT3rCqC2OO8FEb4KOk9FLwnjJ8CxIrXJeqwsBc8MYK9Q7aV0DcpcSqpFcGodPCUgkoqxEgMSzJpIDZesE+cf3SWewPrMWO5Wp125/u+4Z+Qt0/O9Ii59qB39mMAzCKTH+glHTlfd2NcNZm1EGSmGUhs7EFYBnl6DS8uXpGn/HzIA4CcX7vsYy3idXUCjPXa/pCfgRsRVjb3x+C+hRA1hi6N97Bi2/QvcPLsOJp+ZDq3IFw2XuUZjsvpL27kun5slLAKUfAg9hngVEc0jW7krGaEFFO+VESgHech3lOmGSohRtC3tA0byylxtgsCCA/+H6En+VHwycDsEj2Dg5jkk44YI9CX+RwQ9UMYQtc5rpZ/Q5037OMZWxXTrJT5UTZVOJE1SuSh5WldStobimwVHQZQK/b1bKC2dIVF+ZRh+NDptEnY/7fjGgAwurE=
