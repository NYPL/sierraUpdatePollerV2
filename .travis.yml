language: ruby
rvm:
- 2.7.0
before_install:
- wget https://releases.hashicorp.com/terraform/"$TF_VERSION"/terraform_"$TF_VERSION"_linux_amd64.zip
- unzip terraform_"$TF_VERSION"_linux_amd64.zip
- sudo mv terraform /usr/local/bin/
- rm terraform_"$TF_VERSION"_linux_amd64.zip
- gem update --system
- gem install bundler
- gem install aws-sdk-lambda
- gem install aws-sdk-cloudwatchevents
install:
- rake run_bundler
jobs:
  include:
  - stage: test
    script:
    - rake test
  - stage: deploy qa
    if: type IN (push) and branch = qa
    env:
    - AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID_QA
    - AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY_QA
    script:
    - rm -rf vendor
    - bundle install --without test
    - terraform -chdir=provisioning/qa init -input=false
    - echo "Deploying to qa"
    - terraform -chdir=provisioning/qa apply -auto-approve -input=false
  - stage: deploy production
    if: type IN (push) and branch = main
    env:
    - AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID_PRODUCTION
    - AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY_PRODUCTION
    script:
    - rm -rf vendor
    - bundle install --without test
    - terraform -chdir=provisioning/production init -input=false
    - echo "Deploying to production"
    - terraform -chdir=provisioning/production apply -auto-approve -input=false
env:
  global:
  - TF_VERSION=1.0.11
  - secure: SyYsMiszmMAviuty4wNB8lULeyU8LzN5ojYOYzKKTk5/3Nwg2jyaYTCK+ToidEHYJI62T1mL/5kDhdnoatGWG6OEKlbdqeqNV7V/89fwxcNfihUcDrYLUy2xZfTf19cXtsCKOpDmobu1Vh6vNGm3aaIc0hAZZxtzAweKrI9DpIutDzDy5MiffJf5UoAeecxNWVl6RwQ2OinLo//3Necq2ddgTN6po1C7kIUR2DO62fVHjMKu1fxGN4bX1jN2iYxrmL9QfToSH+U9E+ScjNGfc3HnOgoyCdyOtHSb/U6/ZZXXbfY2y6+R+XOv7Sr7SLgJ3qgiuXlDpH6ss27O6C2I9rWrCblh24EUWv8PVW+ATFTF8PFtZ5Q2cIfa2RuqVqOODuUJH6KAJ+ZjQdAa6kvYTtbKuKqwiYjMvFf+aNCw6VVNtPqtoOIpGoZqOjev5P9WNYjI+czl0YqkCl84630mkJNXgBf/JfvcVcBxVp0SfjhoQm6wcaDIoQCcS75Xfhmeikm98ImnLv2ORrayrSp4a1vwMqJdqhpP/+6Zv7RI1xgvDI3PJ/qfLiTN+xcopKo0CoHYNDxPULXpqMUcf1zDPyIxs4PEwRPiuJnM710HISM70FPJhmy+tNyDO1x6JJK/dG8dnzWzZYl0yYiu2Z6JFGnIGxHnhl6YCJVyHld8b/k=
  - secure: cdjozJTGdbjTKbdm7zEuYToDTeG6Iaq/fsR2omcF6Mi7/jPphErnL5L1W2CnTp7bQrdLeXu98kApx79xNY7CQBkuRN/xrmi9XhKK+9vYr2W/S/M20VBYSnc9uprow3LNvMSQvuEkNQcYCQIpv5pmXisAmVMq7zGrvYLmrNnlxUfOk5emWKotRZfGvf3DT6DWAzAj6UHjMQs4SGABvJlhafUND1VgedLEzY6h4cbk+5eh0ykZQpGMT6T9q38T83WF6Hy4gi8MNRD3tUBq9519jVRywluN23479NJ8AlnC5kz1AvSLvZ0UQbNVsa9YUPrNvZtYW13sxqbh+zIZ91OGuk9eyBtT8RUbmfokQA9tTlbajBSvH5HJNbC55HRGOgzzuEAz87/gMt3Rg6UW5iHwWwxwxIvLiXJsxRdGP7w2caZQ/x6spbPU6U/14k7zwe1JO0afcu8HPgmpS2OM+mQNHi4JgG9G74i6DZrMufgiWZC1BDVmQEXBuD+ZLHSIl+Dr9So5O6KKsLGjLVHq+ZqVTR+M9uiIc+aNZIR5v1GTBX588TWtaqB9xqghbGir3qmMMxJtCQTIL1xIjhIXN1F2dbiIPvRnR1ly81MEbYMr0YD5vsRjcP5L3960kGR1E95q6L9FuV7i8IWbnZ8K0Plt0gBKLI9m+7D+il5h7niqjQw=
  - secure: iDtARDAVmOLqEfZtX4A055DVT4kBp5qzh9v2yEmQLLQCu0/ujXDElZGZaNOmzKz0GhBJ3szVMaUKA6253zXFEwA40e91fdQDrLvxdHb9k3kos+SYzPZ58YC6uQE7i2h5Iex7D1EXBv4wdGUZJ942WOogRxdifORkIyKPqb/gE9vhbgFpX1JdXHIaEH5lvjqKdUIu0aylQ/7Fl079cjsXfW5ynJYuvQRz+8YXAsBxBKFinp4udCOFQwoVmk0v8cbdi4BcFNvETM9f3IINQZLnnY12sfScB1GkIRNm0hlkXx9aOsbwDDLQC10I1gFCUH6qCpBc/DPSFnPC9nsOE4Szr3CMezExZJ5C1qoGrKUn2miFMEjDj3DdnXH0JNvySSi6ZGKDpNuhu+LgFoPiLdR6kol40qzOQO+5g3zDFZdhnMCXOZ0fzeMQw5eoU6YUgc5jBj5H5DLSkieYKLIFUqDHHlOkcqiPSEodA21+DJ1F8PGgo6ksot9hckTXZ/o9pBF715cHuF4KvwA7pib2p4Adbb8SMYV/pVu7M5jyXMgapFG+1m5mOagNUG6rFNCP5GwObyUCLj/pgpz7NLNRdS2hgpug8fGvIxQ6HtXJS9MnUwIT5JWoh/creYVuIurTx6DJaYfzb6xlzcOtH4MV0HlbOHP5EYq0KxLeWAaerTDIIb8=
