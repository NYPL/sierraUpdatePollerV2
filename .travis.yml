language: ruby
rvm:
- 2.7.0
before_install:
- wget https://releases.hashicorp.com/terraform/"$TF_VERSION"/terraform_"$TF_VERSION"_linux_amd64.zip
- unzip terraform_"$TF_VERSION"_linux_amd64.zip
- sudo mv terraform /usr/local/bin/
- rm terraform_"$TF_VERSION"_linux_amd64.zip
- gem update --system
- gem install bundler
- gem install aws-sdk-lambda
- gem install aws-sdk-cloudwatchevents
install:
- rake run_bundler
jobs:
  include:
  - stage: test
    script:
    - rake test
  - stage: deploy qa
    if: type IN (push) and branch = qa
    env:
    - AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID_QA
    - AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY_QA
    script:
    - rm -rf vendor
    - bundle install --without test
    - terraform -chdir=provisioning/qa init -input=false
    - echo "Deploying to qa"
    - terraform -chdir=provisioning/qa apply -auto-approve -input=false
  - stage: deploy production
    if: type IN (push) and branch = main
    env:
    - AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID_PRODUCTION
    - AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY_PRODUCTION
    script:
    - rm -rf vendor
    - bundle install --without test
    - terraform -chdir=provisioning/production init -input=false
    - echo "Deploying to production"
    - terraform -chdir=provisioning/production apply -auto-approve -input=false
env:
  global:
  - TF_VERSION=1.0.11
  - secure: BV7FP9Sk9bvK5XlmFc3AJZ2wR4yYHfIGSCN5sHa65HL7/EJZ9BLaXVnVhQcnG9n5DiLoBXL3rwNe6Scb0oOWIdZoJRJZqJvwaFBItojkVdQc4ZrTKmMbYY85hWWZTNinU6+CMQ9Iaw6TuRgRL98n9ZJfd+oJ1u+yRY8q+EbTkPIIyT0oy4fhPyBOHgfdaZRDrsWniCYPwAA0JC+gwLWSBob1JWYwhYbRi0s6HZYU5NGNBL1Z+NCD15g1YkDhAwe2ysqCH+P9PGy++EdAd7iZ3H+FiqZuDy3u2k0O/RfBRVMhkh97I/axsE3Xje20aco/FCE8rVV+Zdurgopn2FK0NfVjlyUKclQetKoEucmHDLOe7XvPVdrN+Vx4KK2r3pBflERluWXj777aQ9Y3vAA5VllJ7VoIMrM34ViFhzUjNw/Wt+880qYqZSnrWJSPNUGBRX1cSZRbWNfGc+B8F+Z6d0rrFmjemlJZLWV5BaHzGq+GORBD1nlEcQhrs4rIubs0rbWsygkduZpAaBnQOPB2bAK9j5LY+8ybB0OJCpc+kpunxgITnfFC3SiFfy90cfc45w3//yLRd4FCHMFjEyCNJsRACxbA3d3Zq9wzEnkIOK/DmYQVYQIjCsCProD9UXMF4W5Cv/rVx1kmP1QolgNsCKcdGbgFw1gzuLdSsndyHqM=
